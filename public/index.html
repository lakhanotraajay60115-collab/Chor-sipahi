<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="title">Chor Sipahi</title>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4058523032052967"
      crossorigin="anonymous"></script>

    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <style>
        :root {
            --king-color: #ffd700;
            --queen-color: #ff69b4;
            --minister-color: #1e90ff;
            --thief-color: #555;
            --sipahi-color: #28a745; 
            --primary-color: #8a2be2; 
            --background-color: #f5f5f5;
            --card-background: #ffffff;
        }
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: var(--background-color); color: #333; text-align: center; }
        .game-container { max-width: 600px; margin: 20px auto; padding: 20px; background-color: var(--card-background); border-radius: 10px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); }
        h1 { color: var(--primary-color); }
        .role-display { padding: 15px; margin: 15px 0; border-radius: 8px; font-size: 1.2em; font-weight: bold; color: white; transition: background-color 0.5s; }
        .role-king { background-color: var(--king-color); }
        .role-queen { background-color: var(--queen-color); }
        .role-minister { background-color: var(--minister-color); }
        .role-thief { background-color: var(--thief-color); }
        .role-sipahi { background-color: var(--sipahi-color); } 
        button { padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        button:hover { opacity: 0.9; }
        #scoreList li { list-style: none; padding: 8px; margin: 5px 0; background-color: #eee; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        #scoreList li span:last-child { font-weight: bold; color: var(--primary-color); }
        #chatBox { border: 1px solid #ccc; height: 150px; overflow-y: scroll; padding: 10px; margin-top: 10px; text-align: left; background-color: #f9f9f9; border-radius: 5px; }
        .chat-message { margin-bottom: 5px; }
        .chat-name { font-weight: bold; color: var(--primary-color); margin-right: 5px; }
        #voteForm label { display: block; margin: 8px 0; text-align: left; }
        .ad-container { margin: 20px 0; border: 1px dashed #ccc; padding: 10px; background-color: #fff8e1; }
        #roomSetup input, #roomSetup button { margin-top: 5px; }
        .lang-selector { margin-bottom: 20px; text-align: right;}
        .lang-selector select { padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
        .inactive-role { background-color: #ccc !important; color: #333 !important; }
    </style>
</head>
<body>
<div class="game-container">
    
    <div class="lang-selector"> 
        <label for="language-select" data-translate="languageLabel"></label>
        <select id="language-select" onchange="handleLanguageChange(this.value)">
            <option value="gu">ркЧрлБркЬрк░рк╛ркдрлА</option>
            <option value="hi">рд╣рд┐рдиреНрджреА</option>
            <option value="en">English</option>
        </select>
    </div>

    <h1 data-translate="appTitle">ЁЯСС ркЪрлЛрк░-рк╕рк┐рккрк╛рк╣рлА ЁЯГП</h1>
    
    <p id="gameStatus" data-translate="connecting">ркХркирлЗркХрлНркЯрк┐ркВркЧ...</p>

    <div class="ad-container" id="ad-slot-top">
        <p data-translate="adLoading">ркЬрк╛рк╣рлЗрк░рк╛ркд рк▓рлЛркб ркеркИ рк░рк╣рлА ркЫрлЗ...</p>
    </div>

    <div id="roomSetup">
        <input type="text" id="playerNameInput" data-translate-placeholder="namePlaceholder" placeholder="ркдркорк╛рк░рлБркВ ркирк╛рко ркжрк╛ркЦрк▓ ркХрк░рлЛ" required style="width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 10px;">
        
        <h3 data-translate="roomTitle">рк░рлВрко ркмркирк╛рк╡рлЛ ркЕркерк╡рк╛ ркЬрлЛркбрк╛ркУ</h3>
        
        <button id="createRoomButton" data-translate="createRoomButton" style="width: 100%; margin-bottom: 10px;">ркирк╡рлЛ рк░рлВрко ркмркирк╛рк╡рлЛ</button>
        
        <p data-translate="or">ркЕркерк╡рк╛</p>

        <input type="text" id="roomIdInput" data-translate-placeholder="roomIdPlaceholder" placeholder="рк░рлВрко ID ркжрк╛ркЦрк▓ ркХрк░рлЛ" style="width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 5px;">
        <button id="joinRoomButton" data-translate="joinRoomButton" style="width: 100%;">рк░рлВркоркорк╛ркВ ркЬрлЛркбрк╛ркУ</button>
    </div>

    <div id="mainGame" style="display: none;">
        <div id="roomInfoContainer" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            <p data-translate="yourRoomId">ркдркорк╛рк░рлЛ рк░рлВрко ID:</p>
            <strong id="displayRoomId" style="font-size: 1.2em; color: var(--primary-color);"></strong>
        </div>

        <button id="startGameButton" data-translate="startGameButton" style="background-color: #007bff; display: none;">ркЧрлЗрко рк╢рк░рлВ ркХрк░рлЛ (рк╣рлЛрк╕рлНркЯ)</button>

        <p id="roundInfo" data-translate-template="roundInfo">рк░рк╛ркЙркирлНркб: рлж/рлзрлж</p>
        
        <p id="roleDisplayWrapper" style="margin-top: 10px; display: none;">
             <strong id="roleDisplay" class="role-display inactive-role" style="padding: 15px; display: block; border-radius: 8px;">ркдркорк╛рк░рлА ркнрлВркорк┐ркХрк╛: ?</strong>
        </p>

        <div id="chatSection">
            <h3 data-translate="chatTitle">ркЦрлЗрк▓рк╛ркбрлАркУ рк╕рк╛ркерлЗ рк╡рк╛ркдркЪрлАркд</h3>
            
            <div id="voiceChatControls" style="margin-top: 10px; margin-bottom: 10px; padding: 10px; border: 1px dashed #ddd; border-radius: 5px;">
                <p id="voiceStatus" data-translate="voiceStatus">рк╡рлЙркЗрк╕ ркЪрлЗркЯ рк╕рлНркЯрлЗркЯрк╕: ркирк┐рк╖рлНркХрлНрк░рк┐ркп</p>
                <button id="toggleMicButton" data-translate="micButtonStart" style="background-color: #ff6347;">ркорк╛ркЗркХ рк╢рк░рлВ ркХрк░рлЛ</button>
            </div>

            <div id="chatBox"></div>
            <div id="chatInputContainer">
                <input type="text" id="chatMessageInput" data-translate-placeholder="chatPlaceholder" placeholder="ркорлЗрк╕рлЗркЬ рк▓ркЦрлЛ...">
                <button id="sendChatButton" data-translate="sendButton">ркорлЛркХрк▓рлЛ</button>
            </div>
        </div>

        <div id="voteSection" style="display: none;">
            <h3 data-translate="votePrompt">ркХрлЛркг ркЪрлЛрк░ ркЫрлЗ? рк╡рлЛркЯ ркХрк░рлЛ:</h3>
            <div id="voteForm" style="display: flex; flex-direction: column;">
            </div>
            <button id="submitVoteButton" data-translate="submitVote">рк╡рлЛркЯ рк╕ркмркорк┐ркЯ ркХрк░рлЛ</button>
        </div>
        
    </div>
    
    <div id="resultDisplay" style="display: none;"></div>
    <div id="scoreDisplay">
        <h3 data-translate="totalScoreTitle">ЁЯПЖ ркХрлБрк▓ рк╕рлНркХрлЛрк░</h3>
        <ul id="scoreList"></ul>
    </div>
    
    <div id="playerList">
        <h3 data-translate="activePlayersTitle">рк╕ркХрлНрк░рк┐ркп ркЦрлЗрк▓рк╛ркбрлАркУ</h3>
        <ul id="playerNamesList"></ul>
    </div>
    
    <div class="ad-container" id="ad-slot-bottom">
        <p data-translate="adLoading">ркЬрк╛рк╣рлЗрк░рк╛ркд рк▓рлЛркб ркеркИ рк░рк╣рлА ркЫрлЗ...</p>
    </div>
</div>

<div id="remoteAudioContainer" style="display: none;"></div> 

<script src="/socket.io/socket.io.js"></script> 

<script>
    const socket = io(); 
    let myId = null;
    let players = {};
    let myRole = '';
    let currentLang = 'gu'; 
    let isHost = false;
    let myRoomId = null;
    
    // рк╡рлЙркЗрк╕ ркЪрлЗркЯ рк╡рлЗрк░рлАркПркмрк▓рлНрк╕
    let localStream = null;
    let peerConnections = {}; 
    const voiceStatusEl = document.getElementById('voiceStatus');
    const toggleMicButton = document.getElementById('toggleMicButton');
    
    const servers = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' } 
        ]
    };


    const MAX_PLAYERS = 8;
    const MIN_PLAYERS = 4;
    
    // ркорлВрк│ркнрлВркд рк░рлЛрк▓ркирк╛ ркирк╛ркорлЛ ркЬрлЗ рк╕рк░рлНрк╡рк░ ркорлЛркХрк▓рлЗ ркЫрлЗ 
    const ROLE_NAMES_GUJ = {
        KING: 'рк░рк╛ркЬрк╛',
        QUEEN: 'рк░рк╛ркгрлА',
        MINISTER: 'рк╡ркЬрлАрк░',
        THIEF: 'ркЪрлЛрк░',
        SIPAHI: 'рк╕рк┐рккрк╛рк╣рлА'
    };


    // --- ркнрк╛рк╖рк╛ркВркдрк░ ркорк╛ркЯрлЗркирлЛ ркорлБркЦрлНркп ркбрлЗркЯрк╛ ркСркмрлНркЬрлЗркХрлНркЯ ---
    const translations = {
        gu: {
            [ROLE_NAMES_GUJ.KING]: 'рк░рк╛ркЬрк╛', 
            [ROLE_NAMES_GUJ.QUEEN]: 'рк░рк╛ркгрлА', 
            [ROLE_NAMES_GUJ.MINISTER]: 'рк╡ркЬрлАрк░', 
            [ROLE_NAMES_GUJ.THIEF]: 'ркЪрлЛрк░', 
            [ROLE_NAMES_GUJ.SIPAHI]: 'рк╕рк┐рккрк╛рк╣рлА', 
            
            title: "ркЪрлЛрк░ рк╕рк┐рккрк╛рк╣рлА", 
            appTitle: "ЁЯСС ркЪрлЛрк░-рк╕рк┐рккрк╛рк╣рлА ЁЯГП", 
            languageLabel: "ркнрк╛рк╖рк╛:",
            namePlaceholder: "ркдркорк╛рк░рлБркВ ркирк╛рко ркжрк╛ркЦрк▓ ркХрк░рлЛ",
            roomTitle: "рк░рлВрко ркмркирк╛рк╡рлЛ ркЕркерк╡рк╛ ркЬрлЛркбрк╛ркУ",
            createRoomButton: "ркирк╡рлЛ рк░рлВрко ркмркирк╛рк╡рлЛ",
            roomIdPlaceholder: "рк░рлВрко ID ркжрк╛ркЦрк▓ ркХрк░рлЛ",
            joinRoomButton: "рк░рлВркоркорк╛ркВ ркЬрлЛркбрк╛ркУ",
            or: "ркЕркерк╡рк╛",
            yourRoomId: "ркдркорк╛рк░рлЛ рк░рлВрко ID:",
            connecting: "ркХркирлЗркХрлНркЯрк┐ркВркЧ...",
            roundInfo: (round, max) => `рк░рк╛ркЙркирлНркб: ${round}/${max}`,
            waiting: (count) => `ркЦрлЗрк▓рк╛ркбрлАркУркирлА рк░рк╛рк╣ ркЬрлЛрк╡рк╛ркп ркЫрлЗ... (${count}/${MAX_PLAYERS})`, 
            gameStarted: "ркЧрлЗрко рк╢рк░рлВ ркеркИ ркЧркИ ркЫрлЗ!",
            totalScoreTitle: "ЁЯПЖ ркХрлБрк▓ рк╕рлНркХрлЛрк░",
            activePlayersTitle: "рк╕ркХрлНрк░рк┐ркп ркЦрлЗрк▓рк╛ркбрлАркУ",
            votePrompt: "ркХрлЛркг ркЪрлЛрк░ ркЫрлЗ? рк╡рлЛркЯ ркХрк░рлЛ:",
            submitVote: "рк╡рлЛркЯ рк╕ркмркорк┐ркЯ ркХрк░рлЛ",
            chatTitle: "ркЦрлЗрк▓рк╛ркбрлАркУ рк╕рк╛ркерлЗ рк╡рк╛ркдркЪрлАркд",
            chatPlaceholder: "ркорлЗрк╕рлЗркЬ рк▓ркЦрлЛ...",
            sendButton: "ркорлЛркХрк▓рлЛ",
            gameEnd: "ркЧрлЗрко рк╕ркорк╛рккрлНркд!",
            winner: (name, score) => `рк╡рк┐ркЬрлЗркдрк╛: ${name} (${score} рккрлЛркИркирлНркЯ)`,
            thiefCaught: (name) => `тЬЕ **ркЪрлЛрк░ рккркХркбрк╛ркИ ркЧркпрлЛ!** (${name})`,
            thiefEscaped: (name, points) => `тЭМ **ркЪрлЛрк░ ркЫркЯркХрлА ркЧркпрлЛ!** (${name} ркирлЗ +${points} рккрлЛркИркирлНркЯ ркорк│рлНркпрк╛)`,
            nextRound: "ркирк╡рк╛ рк░рк╛ркЙркирлНркб ркорк╛ркЯрлЗ ркдрлИркпрк╛рк░ ркерк╛ркУ...",
            adLoading: "ркЬрк╛рк╣рлЗрк░рк╛ркд рк▓рлЛркб ркеркИ рк░рк╣рлА ркЫрлЗ...",
            host: "рк╣рлЛрк╕рлНркЯ",
            yourRole: "ркдркорк╛рк░рлА ркнрлВркорк┐ркХрк╛",
            voiceStatus: "рк╡рлЙркЗрк╕ ркЪрлЗркЯ рк╕рлНркЯрлЗркЯрк╕: ркирк┐рк╖рлНркХрлНрк░рк┐ркп",
            micButtonStart: "ркорк╛ркЗркХ рк╢рк░рлВ ркХрк░рлЛ",
            micButtonStop: "ркорк╛ркЗркХ ркмркВркз ркХрк░рлЛ",
            micPermissionError: "ркорк╛ркЗркХрлНрк░рлЛрклрлЛрки ркНркХрлНрк╕рлЗрк╕ ркирк╛ркоркВркЬрлВрк░ ркеркпрлЛ.",
            startGameButton: "ркЧрлЗрко рк╢рк░рлВ ркХрк░рлЛ (рк╣рлЛрк╕рлНркЯ)"
        },
        hi: {
            [ROLE_NAMES_GUJ.KING]: 'рд░рд╛рдЬрд╛', 
            [ROLE_NAMES_GUJ.QUEEN]: 'рд░рд╛рдиреА', 
            [ROLE_NAMES_GUJ.MINISTER]: 'рд╡рдЬреАрд░', 
            [ROLE_NAMES_GUJ.THIEF]: 'рдЪреЛрд░',
            [ROLE_NAMES_GUJ.SIPAHI]: 'рд╕рд┐рдкрд╛рд╣реА', 
            
            title: "рдЪреЛрд░ рд╕рд┐рдкрд╛рд╣реА", 
            appTitle: "ЁЯСС рдЪреЛрд░-рд╕рд┐рдкрд╛рд╣реА ЁЯГП", 
            languageLabel: "рднрд╛рд╖рд╛:",
            namePlaceholder: "рдЕрдкрдирд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ",
            roomTitle: "рд░реВрдо рдмрдирд╛рдПрдВ рдпрд╛ рдЬреБрдбрд╝реЗрдВ",
            createRoomButton: "рдирдпрд╛ рд░реВрдо рдмрдирд╛рдПрдВ",
            roomIdPlaceholder: "рд░реВрдо ID рджрд░реНрдЬ рдХрд░реЗрдВ",
            joinRoomButton: "рд░реВрдо рдореЗрдВ рдЬреБрдбрд╝реЗрдВ",
            or: "рдпрд╛",
            yourRoomId: "рдЖрдкрдХрд╛ рд░реВрдо ID:",
            connecting: "рдХрдиреЗрдХреНрдЯрд┐рдВрдЧ...",
            roundInfo: (round, max) => `рд░рд╛рдЙрдВрдб: ${round}/${max}`,
            waiting: (count) => `рдЦрд┐рд▓рд╛рдбрд╝рд┐рдпреЛрдВ рдХрд╛ рдЗрдВрддрдЬрд╝рд╛рд░ рд╣реИ... (${count}/${MAX_PLAYERS})`, 
            gameStarted: "ркЧрлЗрко рк╢рк░рлВ ркеркИ ркЧркИ ркЫрлЗ!",
            totalScoreTitle: "ЁЯПЖ рдХреБрд▓ рд╕реНрдХреЛрд░",
            activePlayersTitle: "рд╕рдХреНрд░рд┐рдп рдЦрд┐рд▓рд╛рдбрд╝реА",
            votePrompt: "рдХреМрди рдЪреЛрд░ рд╣реИ? рд╡реЛрдЯ рдХрд░реЗрдВ:",
            submitVote: "рд╡реЛрдЯ рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ",
            chatTitle: "рдЦрд┐рд▓рд╛рдбрд╝рд┐рдпреЛрдВ рд╕реЗ рдмрд╛рддрдЪреАрдд",
            chatPlaceholder: "рдореИрд╕реЗрдЬ рд▓рд┐рдЦреЗрдВ...",
            sendButton: "рднреЗрдЬреЗрдВ",
            gameEnd: "рдЧреЗрдо рд╕рдорд╛рдкреНрдд!",
            winner: (name, score) => `рд╡рд┐рдЬреЗрддрд╛: ${name} (${score} рдкреЙрдЗрдВрдЯреНрд╕)`,
            thiefCaught: (name) => `тЬЕ **рдЪреЛрд░ рдкрдХрдбрд╝рд╛ рдЧрдпрд╛!** (${name})`,
            thiefEscaped: (name, points) => `тЭМ **рдЪреЛрд░ рдмрдЪ рдирд┐рдХрд▓рд╛!** (${name} рдХреЛ +${points} рдкреЙрдЗрдВрдЯреНрд╕ рдорд┐рд▓реЗ)`,
            nextRound: "рдирдП рд░рд╛рдЙрдВрдб рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реЛ рдЬрд╛рдПрдВ...",
            adLoading: "рд╡рд┐рдЬреНрдЮрд╛рдкрди рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...",
            host: "рд╣реЛрд╕реНрдЯ",
            yourRole: "рдЖрдкрдХреА рднреВрдорд┐рдХрд╛",
            voiceStatus: "рд╡реЙрдпрд╕ рдЪреИрдЯ рд╕реНрдЯреЗрдЯрд╕: рдирд┐рд╖реНрдХреНрд░рд┐рдп",
            micButtonStart: "рдорд╛рдЗрдХ рд╢реБрд░реВ рдХрд░реЗрдВ",
            micButtonStop: "рдорд╛рдЗрдХ рдмрдВрдж рдХрд░реЗрдВ",
            micPermissionError: "рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдПрдХреНрд╕реЗрд╕ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ред",
            startGameButton: "рдЧреЗрдо рд╢реБрд░реВ рдХрд░реЗрдВ (рд╣реЛрд╕реНрдЯ)"
        },
        en: {
            [ROLE_NAMES_GUJ.KING]: 'King', 
            [ROLE_NAMES_GUJ.QUEEN]: 'Queen', 
            [ROLE_NAMES_GUJ.MINISTER]: 'Minister', 
            [ROLE_NAMES_GUJ.THIEF]: 'Thief',
            [ROLE_NAMES_GUJ.SIPAHI]: 'Guard', 
            
            title: "Chor Sipahi", 
            appTitle: "ЁЯСС Chor-Sipahi ЁЯГП", 
            languageLabel: "Language:",
            namePlaceholder: "Enter your name",
            roomTitle: "Create or Join a Room",
            createRoomButton: "Create New Room",
            roomIdPlaceholder: "Enter Room ID",
            joinRoomButton: "Join Room",
            or: "OR",
            yourRoomId: "Your Room ID:",
            connecting: "Connecting...",
            roundInfo: (round, max) => `Round: ${round}/${max}`,
            waiting: (count) => `Waiting for players... (${count}/${MAX_PLAYERS})`, 
            gameStarted: "Game has started!",
            totalScoreTitle: "ЁЯПЖ Total Score",
            activePlayersTitle: "Active Players",
            votePrompt: "Who is the Thief? Vote:",
            submitVote: "Submit Vote",
            chatTitle: "Chat with Players",
            chatPlaceholder: "Type message...",
            sendButton: "Send",
            gameEnd: "Game Over!",
            winner: (name, score) => `Winner: ${name} (${score} points)`,
            thiefCaught: (name) => `тЬЕ **Thief was caught!** (${name})`,
            thiefEscaped: (name, points) => `тЭМ **Thief escaped!** (${name} got +${points} points)`,
            nextRound: "Get ready for the next round...",
            adLoading: "Ad is loading...",
            host: "Host",
            yourRole: "Your Role",
            voiceStatus: "Voice Chat Status: Inactive",
            micButtonStart: "Start Mic",
            micButtonStop: "Stop Mic",
            micPermissionError: "Microphone access denied.",
            startGameButton: "Start Game (Host)"
        }
    };

    const roleColors = {
        [ROLE_NAMES_GUJ.KING]: 'role-king', 
        [ROLE_NAMES_GUJ.QUEEN]: 'role-queen', 
        [ROLE_NAMES_GUJ.MINISTER]: 'role-minister', 
        [ROLE_NAMES_GUJ.THIEF]: 'role-thief',
        [ROLE_NAMES_GUJ.SIPAHI]: 'role-sipahi'
    };


    // --- ркЙрккркпрлЛркЧрлА UI рклркВркХрлНрк╢ркирлНрк╕ ---
    
    function getPlayerName() {
        const name = document.getElementById('playerNameInput').value.trim();
        if (!name) {
             alert(translations[currentLang].namePlaceholder || 'ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркдркорк╛рк░рлБркВ ркирк╛рко ркжрк╛ркЦрк▓ ркХрк░рлЛ.');
             return null;
        }
        return name;
    }

    function updateScoreboard(finalScores) {
        const list = document.getElementById('scoreList');
        list.innerHTML = '';
        
        const sortedPlayers = Object.values(finalScores).sort((a, b) => b.totalScore - a.totalScore);

        sortedPlayers.forEach(p => {
            const item = document.createElement('li');
            item.innerHTML = `
                <span>${p.name}</span>
                <span>${p.totalScore}</span>
            `;
            list.appendChild(item);
        });
    }

    function displayRoundResult(data) {
        const resultEl = document.getElementById('resultDisplay');
        const langData = translations[data.currentLanguage] || translations.gu;
        
        const thiefName = data.thiefName;
        const message = data.thiefCaught 
            ? langData.thiefCaught(thiefName)
            : langData.thiefEscaped(thiefName, data.thiefPointsGain);
            
        resultEl.style.display = 'block';
        resultEl.innerHTML = `
            <h2>${message}</h2>
            <p>${langData.nextRound}</p>
        `;
    }
    
    // --- UI ркЕрккркбрлЗркЯ ркХрк░рлЛ (ркЯрлНрк░рк╛ркирлНрк╕рк▓рлЗрк╢рки ркЕркирлЗ рк╕рлНркЯрлЗркЯрк╕) ---
    function translateUI() {
        const langData = translations[currentLang] || translations.gu;

        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if (langData[key] && typeof langData[key] === 'string') {
                el.textContent = langData[key];
            }
        });
        document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
            const key = el.getAttribute('data-translate-placeholder');
            if (langData[key] && typeof langData[key] === 'string') {
                el.placeholder = langData[key];
            }
        });
        
        document.title = langData.title;

        const roundInfoEl = document.getElementById('roundInfo');
        if (roundInfoEl.dataset.round && roundInfoEl.dataset.max) {
             roundInfoEl.textContent = langData.roundInfo(roundInfoEl.dataset.round, roundInfoEl.dataset.max);
        } else {
             roundInfoEl.textContent = langData.roundInfo(0, 10);
        }
        
        const statusEl = document.getElementById('gameStatus');
        if (statusEl.dataset.status) {
            const count = parseInt(statusEl.dataset.status);
            
            // ркЬрлЛ рк░рлВрко ркмркирлНркпрлЛ рк╣рлЛркп ркЕркирлЗ MIN_PLAYERS ркХрк░ркдрк╛ ркУркЫрк╛ рк╣рлЛркп
            if(myRoomId && count < MIN_PLAYERS) {
                 statusEl.textContent = langData.waiting(count);
            } else if (myRoomId && count >= MIN_PLAYERS) {
                 statusEl.textContent = langData.gameStarted; 
            } else if (!myRoomId) {
                 statusEl.textContent = langData.connecting;
            }
        }
        
        const roleEl = document.getElementById('roleDisplay');
        const defaultRoleLabel = langData.yourRole || 'ркдркорк╛рк░рлА ркнрлВркорк┐ркХрк╛'; 
        
        if(myRole) {
            const translatedRole = langData[myRole] || myRole; 
            roleEl.textContent = `${defaultRoleLabel}: ${translatedRole}`;
            roleEl.classList.remove('inactive-role');
        } else if (roleEl) {
            roleEl.textContent = `${defaultRoleLabel}: ?`;
            roleEl.className = 'role-display inactive-role';
        }
        
        document.getElementById('language-select').value = currentLang;
        
        if (Object.keys(players).length > 0) {
            updatePlayerList(Object.values(players)); 
        }

        if (toggleMicButton && voiceStatusEl) {
            if (localStream) {
                 toggleMicButton.textContent = langData.micButtonStop;
                 const activeText = currentLang === 'gu' ? 'рк╕ркХрлНрк░рк┐ркп' : currentLang === 'hi' ? 'рд╕рдХреНрд░рд┐рдп' : 'Active';
                 voiceStatusEl.textContent = langData.voiceStatus.replace(/(ркирк┐рк╖рлНркХрлНрк░рк┐ркп|Inactive|рдирд┐рд╖реНркХрлНрк░рк┐ркп)/, activeText);
                 toggleMicButton.style.backgroundColor = '#4CAF50'; 
            } else {
                 toggleMicButton.textContent = langData.micButtonStart;
                 voiceStatusEl.textContent = langData.voiceStatus;
                 toggleMicButton.style.backgroundColor = '#ff6347'; 
            }
        }
        
        document.getElementById('startGameButton').textContent = langData.startGameButton;
    }

    function updatePlayerList(playerData) {
        if (!Array.isArray(playerData)) {
            playerData = Object.values(playerData);
        }
        
        players = {};
        playerData.forEach(p => players[p.id] = p);
        
        const langData = translations[currentLang] || translations.gu;
        const list = document.getElementById('playerNamesList');
        list.innerHTML = '';
        
        playerData.forEach(p => {
            const item = document.createElement('li');
            const hostLabel = p.isHost ? ` (${langData.host})` : ''; 
            item.textContent = p.name + hostLabel;
            list.appendChild(item);
        });

        const statusEl = document.getElementById('gameStatus');
        statusEl.dataset.status = playerData.length;
        
        translateUI(); // рк╕рлНркЯрлЗркЯрк╕ ркЕркирлЗ ркмркЯрки ркЕрккркбрлЗркЯ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ

        // рк╣рлЛрк╕рлНркЯ ркмркЯркиркирлБркВ ркбрк┐рк╕рлНрккрлНрк▓рлЗ
        const startGameButton = document.getElementById('startGameButton');
        const isGameStarted = players[myId] && players[myId].currentRole;

        if (isHost && !isGameStarted) { 
            startGameButton.style.display = 'block';
            startGameButton.disabled = playerData.length < MIN_PLAYERS;
        } else {
            startGameButton.style.display = 'none';
        }
        
        if (localStream) {
            startAllPeerConnections(); 
        }
    }

    function handleLanguageChange(lang) {
        currentLang = lang;
        translateUI(); 
        
        if (myRoomId && isHost) {
            socket.emit('setLanguage', lang);
        }
    }
    
    window.handleLanguageChange = handleLanguageChange;

    function createVoteForm() {
        const form = document.getElementById('voteForm');
        form.innerHTML = '';
        
        Object.values(players).filter(p => p.id !== myId).forEach(p => {
            const label = document.createElement('label');
            label.innerHTML = `
                <input type="radio" name="thiefVote" value="${p.id}" required>
                ${p.name}
            `;
            form.appendChild(label);
        });
        
        document.getElementById('voteSection').style.display = 'block';
        document.getElementById('submitVoteButton').disabled = false;
        
        document.querySelector('#voteSection h3').textContent = translations[currentLang].votePrompt;
    }

    function resetGameUI() {
        document.getElementById('mainGame').style.display = 'none';
        document.getElementById('resultDisplay').style.display = 'none';
        document.getElementById('voteSection').style.display = 'none';
        document.getElementById('startGameButton').style.display = 'none'; 
        document.getElementById('roomSetup').style.display = 'block';
        
        // ркнрлВркорк┐ркХрк╛ рк░рлАрк╕рлЗркЯ ркХрк░рлЛ
        const roleEl = document.getElementById('roleDisplay');
        roleEl.textContent = translations[currentLang].yourRole + ': ?';
        roleEl.className = 'role-display inactive-role';
        document.getElementById('roleDisplayWrapper').style.display = 'none';

        document.getElementById('scoreList').innerHTML = '';
        document.getElementById('playerNamesList').innerHTML = '';
        document.getElementById('displayRoomId').textContent = '';
        document.getElementById('chatBox').innerHTML = '';
        myRole = ''; 
        myRoomId = null;
        isHost = false;
        
        // рк╡рлЙркЗрк╕ ркХркирлЗркХрлНрк╢ркирлНрк╕ ркмркВркз ркХрк░рлЛ
        stopMic();
        Object.keys(peerConnections).forEach(id => closePeerConnection(id));
        
        translateUI(); 
    }
    
    // --- WebRTC ркХркирлЗркХрлНрк╢рки рк▓рлЛркЬрк┐ркХ ---

    function createPeerConnection(remoteId, isOfferer) {
        const pc = new RTCPeerConnection(servers);
        
        if (localStream) {
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        }

        pc.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit('iceCandidate', {
                    candidate: event.candidate,
                    toId: remoteId
                });
            }
        };
        
        pc.ontrack = (event) => {
            if (event.track.kind === 'audio') {
                let remoteAudio = document.getElementById(`audio-${remoteId}`);
                if (!remoteAudio) {
                    remoteAudio = document.createElement('audio');
                    remoteAudio.id = `audio-${remoteId}`;
                    remoteAudio.autoplay = true;
                    remoteAudio.muted = false; 
                    document.getElementById('remoteAudioContainer').appendChild(remoteAudio); 
                }
                remoteAudio.srcObject = event.streams[0];
                console.log(`Received audio track from ${remoteId}`);
            }
        };

        peerConnections[remoteId] = pc;
        
        if (isOfferer) {
            pc.createOffer()
                .then(offer => pc.setLocalDescription(offer))
                .then(() => {
                    socket.emit('offer', {
                        offer: pc.localDescription,
                        toId: remoteId
                    });
                });
        }
        
        return pc;
    }

    function startAllPeerConnections() {
        const playersInRoom = Object.keys(players);
        playersInRoom.forEach(playerId => {
            if (playerId !== myId && !peerConnections[playerId]) {
                if (isHost) { 
                    createPeerConnection(playerId, true);
                }
            }
        });
        
        if(myRoomId && localStream) { // ркЬрлЛ ркорк╛ркЗркХ ркЪрк╛рк▓рлБ рк╣рлЛркп ркдрлЛ ркЬ рк░рлЗркбрлА рк╕рк┐ркЧрлНркирк▓ ркорлЛркХрк▓рлЛ
             socket.emit('voiceReady');
        }
    }

    function closePeerConnection(remoteId) {
        if (peerConnections[remoteId]) {
            peerConnections[remoteId].close();
            delete peerConnections[remoteId];
            
            const audioEl = document.getElementById(`audio-${remoteId}`);
            if (audioEl) audioEl.remove();
        }
    }
    
    // --- ркорк╛ркЗркХрлНрк░рлЛрклрлЛрки ркНркХрлНрк╕рлЗрк╕ рклркВркХрлНрк╢рки ---
    async function startMic() {
        if (localStream) return; 

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            localStream = stream;
            
            translateUI(); // рк╕рлНркЯрлЗркЯрк╕ ркЕркирлЗ ркмркЯрки ркЕрккркбрлЗркЯ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ
            
            toggleMicButton.removeEventListener('click', startMic);
            toggleMicButton.addEventListener('click', stopMic);
            
            Object.values(peerConnections).forEach(pc => {
                 localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            });
            
            if(myRoomId) {
                 startAllPeerConnections();
            }

        } catch (err) {
            console.error("Error accessing microphone:", err);
            alert(translations[currentLang].micPermissionError);
            localStream = null;
            translateUI(); // ркирк┐рк╖рлНркХрлНрк░рк┐ркп рк╕рлНркЯрлЗркЯрк╕ рккрк░ рккрк╛ркЫрк╛ ркЖрк╡рк╡рк╛ ркорк╛ркЯрлЗ
        }
    }

    function stopMic() {
        if (localStream) {
            localStream.getTracks().forEach(track => {
                Object.values(peerConnections).forEach(pc => {
                    pc.getSenders().forEach(sender => {
                        if (sender.track === track) {
                            pc.removeTrack(sender);
                        }
                    });
                });
                track.stop();
            });
            localStream = null;
        }
        
        translateUI(); // ркирк┐рк╖рлНркХрлНрк░рк┐ркп рк╕рлНркЯрлЗркЯрк╕ ркЕркирлЗ ркмркЯрки ркЕрккркбрлЗркЯ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ
        toggleMicButton.removeEventListener('click', stopMic);
        toggleMicButton.addEventListener('click', startMic);
        
        if(myRoomId) {
             socket.emit('voiceStop');
        }
    }

    // --- Socket ркЗрк╡рлЗркирлНркЯрлНрк╕ ркЕркирлЗ WebRTC рк╕рк┐ркЧрлНркирк▓рк┐ркВркЧ рк╣рлЗркирлНркбрк▓рк░рлНрк╕ ---

    socket.on('connect', () => {
        myId = socket.id;
        document.getElementById('gameStatus').textContent = translations[currentLang].connecting; 
        translateUI(); 
    });

    socket.on('error', (message) => {
        alert(`ркнрлВрк▓: ${message}`);
        
        // ркЬрлЛ рк░рлВрко ркмркирк╛рк╡рк╡рк╛ркорк╛ркВ/ркЬрлЛркбрк╛рк╡рк╛ркорк╛ркВ ркнрлВрк▓ ркерк╛ркп, ркдрлЛ UI рк░рлАрк╕рлЗркЯ ркХрк░рлЛ
        if (!myRoomId) {
             resetGameUI();
        }
    });

    socket.on('roomCreated', (data) => {
        myRoomId = data.roomId;
        currentLang = data.currentLanguage;
        isHost = data.isHost;

        document.getElementById('roomSetup').style.display = 'none';
        document.getElementById('mainGame').style.display = 'block';
        document.getElementById('displayRoomId').textContent = myRoomId;
        document.getElementById('roleDisplayWrapper').style.display = 'block'; // ркнрлВркорк┐ркХрк╛ wrapper ркмркдрк╛рк╡рлЛ
        
        handleLanguageChange(currentLang); 
        
        alert(`рк░рлВрко ${myRoomId} ркмркирк╛рк╡рк╡рк╛ркорк╛ркВ ркЖрк╡рлНркпрлЛ. ркЖ ID ркдркорк╛рк░рк╛ ркорк┐ркдрлНрк░рлЛркирлЗ ркорлЛркХрк▓рлЛ!`);
    });

    socket.on('roomJoined', (data) => {
        myRoomId = data.roomId;
        currentLang = data.currentLanguage;
        isHost = data.isHost;

        document.getElementById('roomSetup').style.display = 'none';
        document.getElementById('mainGame').style.display = 'block';
        document.getElementById('displayRoomId').textContent = myRoomId;
        document.getElementById('roleDisplayWrapper').style.display = 'block'; // ркнрлВркорк┐ркХрк╛ wrapper ркмркдрк╛рк╡рлЛ

        handleLanguageChange(currentLang);
    });
    
    // --- WebRTC рк╕рк┐ркЧрлНркирк▓рк┐ркВркЧ рк░рлАрк╕рлАрк╡рк░рлНрк╕ ---

    socket.on('userReadyForVoice', (userId) => {
        if (isHost && localStream) {
            createPeerConnection(userId, true);
        }
    });

    socket.on('offer', (data) => {
        let pc = peerConnections[data.fromId];
        if (!pc) {
            pc = createPeerConnection(data.fromId, false);
        }

        pc.setRemoteDescription(new RTCSessionDescription(data.offer))
            .then(() => pc.createAnswer())
            .then(answer => pc.setLocalDescription(answer))
            .then(() => {
                socket.emit('answer', {
                    answer: pc.localDescription,
                    toId: data.fromId
                });
            });
    });

    socket.on('answer', (data) => {
        const pc = peerConnections[data.fromId];
        if (pc) {
            pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
    });

    socket.on('iceCandidate', (data) => {
        const pc = peerConnections[data.fromId];
        if (pc && data.candidate) {
             if (pc.remoteDescription) {
                pc.addIceCandidate(new RTCIceCandidate(data.candidate))
                    .catch(e => console.error('Error adding received ice candidate:', e));
             }
        }
    });

    socket.on('userDisconnectedVoice', (userId) => {
        closePeerConnection(userId);
    });


    // --- ркЧрлЗрко ркЕркирлЗ ркЪрлЗркЯ рк╣рлЗркирлНркбрк▓рк░рлНрк╕ ---
    socket.on('setHost', (hostStatus) => {
        isHost = hostStatus;
        translateUI();
    });

    socket.on('languageChanged', (newLang) => {
        currentLang = newLang;
        document.getElementById('language-select').value = newLang; 
        translateUI();
    });

    socket.on('playerListUpdate', (playerData) => {
        updatePlayerList(playerData);
    });

    socket.on('newRound', (data) => {
        document.getElementById('resultDisplay').style.display = 'none';
        document.getElementById('voteSection').style.display = 'none'; 
        document.getElementById('startGameButton').style.display = 'none'; 
        
        const roundInfoEl = document.getElementById('roundInfo');
        roundInfoEl.dataset.round = data.round;
        roundInfoEl.dataset.max = data.maxRounds;
        
        translateUI(); 

        // 2 рк╕рлЗркХркирлНркб рккркЫрлА рк╡рлЛркЯ рклрлЛрк░рлНрко ркмркирк╛рк╡рлЛ
        setTimeout(createVoteForm, 2000); 
    });

    // *** рк╕рлБркзрк╛рк░рлЗрк▓рлБркВ ркнрлВркорк┐ркХрк╛ ркбрк┐рк╕рлНрккрлНрк▓рлЗ рк▓рлЛркЬрк┐ркХ ***
    socket.on('yourRole', (role) => {
        myRole = role;
        
        const roleEl = document.getElementById('roleDisplay');
        
        translateUI(); // ркнрлВркорк┐ркХрк╛ркирлБркВ ркнрк╛рк╖рк╛ркВркдрк░ ркЕркирлЗ рк╕рлНркЯрлЗркЯрк╕ ркЕрккркбрлЗркЯ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ
        
        // ркХрлНрк▓рк╛рк╕ ркЕркирлЗ рк╕рлНркЯрк╛ркЗрк▓ ркЕрккркбрлЗркЯ ркХрк░рлЛ
        roleEl.className = 'role-display'; // ркорлВрк│ркнрлВркд ркХрлНрк▓рк╛рк╕ рк░рлАрк╕рлЗркЯ ркХрк░рлЛ
        roleEl.classList.add(roleColors[role] || 'role-default'); // рк░ркВркЧ ркХрлНрк▓рк╛рк╕ ркЙркорлЗрк░рлЛ
        
        if (role === ROLE_NAMES_GUJ.THIEF) {
            document.getElementById('voteSection').style.display = 'none'; 
        } else {
            document.getElementById('voteSection').style.display = 'block';
        }
    });
    // **********************************

    socket.on('roundResult', (data) => {
        displayRoundResult(data);
        updateScoreboard(data.players);
    });

    socket.on('chatMessage', (data) => {
        const chatBox = document.getElementById('chatBox');
        const messageEl = document.createElement('div');
        messageEl.className = 'chat-message';
        messageEl.innerHTML = `<span class="chat-name">${data.name}:</span> ${data.message} <span style="font-size: 0.7em; color: #888;">(${data.timestamp})</span>`;
        chatBox.appendChild(messageEl);
        chatBox.scrollTop = chatBox.scrollHeight;
    });
    
    socket.on('loadChatHistory', (history) => {
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML = ''; 
        
        history.forEach(data => {
            const messageEl = document.createElement('div');
            messageEl.className = 'chat-message';
            messageEl.innerHTML = `<span class="chat-name">${data.name}:</span> ${data.message} <span style="font-size: 0.7em; color: #888;">(${data.timestamp})</span>`;
            chatBox.appendChild(messageEl);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
    });


    socket.on('gameEnd', (data) => {
        const resultEl = document.getElementById('resultDisplay');
        const langData = translations[data.currentLanguage] || translations.gu;
        
        resultEl.style.display = 'block';
        resultEl.innerHTML = `
            <h2>${langData.gameEnd}</h2>
            <p>${langData.winner(data.winner.name, data.winner.totalScore)}</p>
            <button onclick="window.location.reload()" style="background-color: #ff6347;">ркирк╡рлА ркЧрлЗрко рк╢рк░рлВ ркХрк░рлЛ</button>
        `;
        document.getElementById('mainGame').style.display = 'none';
        updateScoreboard(data.finalScores);
    });

    // --- UI ркЗрк╡рлЗркирлНркЯ рк╣рлЗркирлНркбрк▓рк░рлНрк╕ ---

    document.getElementById('createRoomButton').addEventListener('click', () => {
        const name = getPlayerName();
        if (name) {
            socket.emit('createRoom', name);
        }
    });

    document.getElementById('joinRoomButton').addEventListener('click', () => {
        const name = getPlayerName();
        const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
        
        if (!name) return;

        if (roomId.length < 4) {
             alert('рк░рлВрко ID ркорк╛ркВ ркУркЫрк╛ркорк╛ркВ ркУркЫрк╛ рлк ркЕркХрлНрк╖рк░рлЛ рк╣рлЛрк╡рк╛ ркЬрлЛркИркП.');
             return;
        }
        
        socket.emit('joinRoom', { roomId, name });
    });
    
    document.getElementById('startGameButton').addEventListener('click', () => {
        socket.emit('startGame');
    });

    document.getElementById('submitVoteButton').addEventListener('click', () => {
        const selectedVote = document.querySelector('input[name="thiefVote"]:checked');
        if (selectedVote) {
            socket.emit('submitVote', selectedVote.value);
            document.getElementById('submitVoteButton').disabled = true;
            document.getElementById('voteSection').style.display = 'none';
        } else {
            alert('ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркХрлЛркИ ркЦрлЗрк▓рк╛ркбрлАркирлЗ рк╡рлЛркЯ ркХрк░рлЛ.');
        }
    });

    document.getElementById('sendChatButton').addEventListener('click', () => {
        const input = document.getElementById('chatMessageInput');
        const message = input.value.trim();
        if (message) {
            socket.emit('chatMessage', message);
            input.value = '';
        }
    });
    
    document.getElementById('chatMessageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('sendChatButton').click();
        }
    });
    
    // рк╡рлЙркЗрк╕ ркХркВркЯрлНрк░рлЛрк▓ ркЗрк╡рлЗркирлНркЯ рк▓рк┐рк╕ркирк░
    toggleMicButton.addEventListener('click', startMic);

    // рккрлНрк░ркерко рк▓рлЛркб рккрк░ UI ркЯрлНрк░рк╛ркирлНрк╕рк▓рлЗркЯ ркХрк░рлЛ
    translateUI();
</script>

<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('SW registered: ', registration);
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
</script>
</body>
            </html>
