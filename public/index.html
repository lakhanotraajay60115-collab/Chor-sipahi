<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="title">рк░рк╛ркЬрк╛-рк░рк╛ркгрлА-рк╡ркЬрлАрк░-ркЪрлЛрк░</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <style>
        :root {
            --king-color: #ffd700;
            --queen-color: #ff69b4;
            --minister-color: #1e90ff;
            --thief-color: #555;
            --primary-color: #8a2be2; /* Blue Violet */
            --background-color: #f5f5f5;
            --card-background: #ffffff;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .game-container {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        h1 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* ркнрлВркорк┐ркХрк╛ ркХрк╛рк░рлНркб */
        #roleDisplay {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4);
            animation: fadeIn 1s ease-in-out;
        }
        .role-king { background-color: var(--king-color); }
        .role-queen { background-color: var(--queen-color); }
        .role-minister { background-color: var(--minister-color); }
        .role-thief { background-color: var(--thief-color); }

        /* Host рк╕рк┐рк▓рлЗркХрлНркЯрк░ рк╕рлНркЯрк╛ркЗрк▓ */
        .lang-selector {
            margin-bottom: 15px;
            text-align: right;
            font-size: 0.9em;
        }
        #language-select {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid var(--primary-color);
        }

        /* рк╡рлЛркЯрк┐ркВркЧ рклрлЛрк░рлНрко */
        #voteSection {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: left;
        }
        #voteForm label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        /* ркмркЯрки рк╕рлНркЯрк╛ркЗрк▓ */
        button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #6a1b9a; }
        
        /* рк╕рлНркХрлЛрк░ркмрлЛрк░рлНркб */
        #scoreDisplay, #playerList {
            margin-top: 20px;
            border-top: 1px dashed #ccc;
            padding-top: 15px;
        }
        #scoreDisplay ul { list-style: none; padding: 0; }
        #scoreDisplay li { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px; 
            margin-bottom: 5px; 
            background: #eee; 
            border-radius: 4px;
        }
        
        /* ркЪрлЗркЯ ркмрлЛркХрлНрк╕ */
        #chatBox {
            margin-top: 30px;
            border: 1px solid #ccc;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            text-align: left;
            background-color: #fafafa;
        }
        #chatInputContainer {
            display: flex;
            margin-top: 10px;
        }
        #chatMessageInput {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px 0 0 4px;
        }
        #sendChatButton {
            width: 80px;
            margin-top: 0;
            border-radius: 0 4px 4px 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

    </style>
</head>
<body>

<div class="game-container">
    
    <div class="lang-selector" style="display: none;"> 
        <label for="language-select" data-translate="languageLabel">ркнрк╛рк╖рк╛:</label>
        <select id="language-select" onchange="handleLanguageChange(this.value)">
            <option value="gu">ркЧрлБркЬрк░рк╛ркдрлА</option>
            <option value="hi">рд╣рд┐рдиреНрджреА</option>
            <option value="en">English</option>
        </select>
    </div>

    <h1 data-translate="appTitle">ЁЯСС рк░рк╛ркЬрк╛-рк░рк╛ркгрлА-рк╡ркЬрлАрк░-ркЪрлЛрк░ ЁЯГП</h1>
    
    <p id="gameStatus" data-translate="connecting">ркХркирлЗркХрлНркЯрк┐ркВркЧ...</p>

    <div id="nameRegistration">
        <input type="text" id="playerNameInput" placeholder="ркдркорк╛рк░рлБркВ ркирк╛рко ркжрк╛ркЦрк▓ ркХрк░рлЛ" required style="width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 10px;">
        <button id="registerButton" data-translate="registerButton">ркЬрлЛркбрк╛ркУ (Join)</button>
    </div>

    <div id="mainGame" style="display: none;">
        <p id="roundInfo" data-translate-template="roundInfo">рк░рк╛ркЙркирлНркб: рлж/рлзрлж</p>
        
        <div id="roleDisplay">ркдркорк╛рк░рлА ркнрлВркорк┐ркХрк╛: ?</div>

        <div id="voteSection">
            <h3 data-translate="votePrompt">ркХрлЛркг ркЪрлЛрк░ ркЫрлЗ? рк╡рлЛркЯ ркХрк░рлЛ:</h3>
            <div id="voteForm" style="display: flex; flex-direction: column;">
                </div>
            <button id="submitVoteButton" data-translate="submitVote">рк╡рлЛркЯ рк╕ркмркорк┐ркЯ ркХрк░рлЛ</button>
        </div>

        <div id="chatSection">
            <h3 data-translate="chatTitle">ркЦрлЗрк▓рк╛ркбрлАркУ рк╕рк╛ркерлЗ рк╡рк╛ркдркЪрлАркд (ркорк╛ркЗркХрлНрк░рлЛрклрлЛрки ркЪрлЗркЯркирлЗ ркмркжрк▓рлЗ)</h3>
            <div id="chatBox"></div>
            <div id="chatInputContainer">
                <input type="text" id="chatMessageInput" data-translate-placeholder="chatPlaceholder" placeholder="ркорлЗрк╕рлЗркЬ рк▓ркЦрлЛ...">
                <button id="sendChatButton" data-translate="sendButton">ркорлЛркХрк▓рлЛ</button>
            </div>
        </div>
        
    </div>
    
    <div id="resultDisplay" style="display: none;"></div>
    <div id="scoreDisplay">
        <h3 data-translate="totalScoreTitle">ЁЯПЖ ркХрлБрк▓ рк╕рлНркХрлЛрк░</h3>
        <ul id="scoreList"></ul>
    </div>
    
    <div id="playerList">
        <h3 data-translate="activePlayersTitle">рк╕ркХрлНрк░рк┐ркп ркЦрлЗрк▓рк╛ркбрлАркУ</h3>
        <ul id="playerNamesList"></ul>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script> 

<script>
    const socket = io(); 
    let myId = null;
    let players = {};
    let myRole = '';
    let currentLang = 'gu'; // Default to Gujarati
    let isHost = false;

    // --- ркнрк╛рк╖рк╛ркВркдрк░ ркорк╛ркЯрлЗркирлЛ ркорлБркЦрлНркп ркбрлЗркЯрк╛ ркСркмрлНркЬрлЗркХрлНркЯ ---
    const translations = {
        gu: {
            title: "рк░рк╛ркЬрк╛-рк░рк╛ркгрлА-рк╡ркЬрлАрк░-ркЪрлЛрк░",
            appTitle: "ЁЯСС рк░рк╛ркЬрк╛-рк░рк╛ркгрлА-рк╡ркЬрлАрк░-ркЪрлЛрк░ ЁЯГП",
            languageLabel: "ркнрк╛рк╖рк╛:",
            connecting: "ркХркирлЗркХрлНркЯрк┐ркВркЧ...",
            registerButton: "ркЬрлЛркбрк╛ркУ (Join)",
            votePrompt: "ркХрлЛркг ркЪрлЛрк░ ркЫрлЗ? рк╡рлЛркЯ ркХрк░рлЛ:",
            submitVote: "рк╡рлЛркЯ рк╕ркмркорк┐ркЯ ркХрк░рлЛ",
            chatTitle: "ркЦрлЗрк▓рк╛ркбрлАркУ рк╕рк╛ркерлЗ рк╡рк╛ркдркЪрлАркд (ркорк╛ркЗркХрлНрк░рлЛрклрлЛрки ркЪрлЗркЯркирлЗ ркмркжрк▓рлЗ)",
            sendButton: "ркорлЛркХрк▓рлЛ",
            totalScoreTitle: "ЁЯПЖ ркХрлБрк▓ рк╕рлНркХрлЛрк░",
            activePlayersTitle: "рк╕ркХрлНрк░рк┐ркп ркЦрлЗрк▓рк╛ркбрлАркУ",
            chatPlaceholder: "ркорлЗрк╕рлЗркЬ рк▓ркЦрлЛ...",
            roundInfo: (round, max) => `рк░рк╛ркЙркирлНркб: ${round}/${max}`,
            waiting: (count) => `ркЦрлЗрк▓рк╛ркбрлАркУркирлА рк░рк╛рк╣ ркЬрлЛрк╡рк╛ркп ркЫрлЗ... (${count}/рлк)`,
            startStatus: (round) => `ркирк╡рлЛ рк░рк╛ркЙркирлНркб ${round} рк╢рк░рлВ! ркЪрлЛрк░ркирлЗ рк╢рлЛркзрлЛ.`,
            voteSubmitted: "ркдркорк╛рк░рлЛ рк╡рлЛркЯ рк╕ркмркорк┐ркЯ ркеркИ ркЧркпрлЛ ркЫрлЗ. ркЕркирлНркп ркЦрлЗрк▓рк╛ркбрлАркУркирлА рк░рк╛рк╣ ркЬрлБркУ...",
            alertVote: "ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркЪрлЛрк░ркирлЗ рк╡рлЛркЯ ркХрк░рлЛ.",
            roundResultTitle: (round) => `рк░рк╛ркЙркирлНркб ${round} рккрк░рк┐ркгрк╛рко`,
            thiefResult: (name, caught) => `рк╕рк╛ркЪрлЛ ркЪрлЛрк░: ${name} (${caught ? 'рккркХркбрк╛ркИ ркЧркпрлЛ!' : 'рккркХркбрк╛ркпрлЛ ркиркерлА!'})`,
            scoreDetailsTitle: "рк╡рлНркпркХрлНркдрк┐ркЧркд рк╕рлНркХрлЛрк░ рк╡рк┐ркЧркдрлЛ:",
            nextRoundWait: (round) => `ркирк╡рлЛ рк░рк╛ркЙркирлНркб ${round} рлзрлж рк╕рлЗркХркирлНркбркорк╛ркВ рк╢рк░рлВ ркерк╢рлЗ.`,
            gameEndTitle: "ЁЯОЙ ркЧрлЗрко рк╕ркорк╛рккрлНркд!",
            gameEndWinner: (name) => `рк╡рк┐ркЬрлЗркдрк╛: ${name}`,
            gameEndMessage: (msg) => `ркЧрлЗрко рк╕ркорк╛рккрлНркд. ${msg}`,
            hostMessage: "ркдркорлЗ Host ркЫрлЛ. ркдркорлЗ ркнрк╛рк╖рк╛ ркмркжрк▓рлА рк╢ркХрлЛ ркЫрлЛ.",
            playerMessage: "ркдркорлЗ ркЦрлЗрк▓рк╛ркбрлА ркЫрлЛ.",
            languageChangeAlert: "Host ркП ркнрк╛рк╖рк╛ ркмркжрк▓рлА ркЫрлЗ.",
            totalPoints: (score) => `ркХрлБрк▓ рккрлЛркИркирлНркЯ: ${score}`,
        },
        hi: {
            title: "рд░рд╛рдЬрд╛-рд░рд╛рдиреА-рд╡рдЬреАрд░-рдЪреЛрд░",
            appTitle: "ЁЯСС рд░рд╛рдЬрд╛-рд░рд╛рдиреА-рд╡рдЬреАрд░-рдЪреЛрд░ ЁЯГП",
            languageLabel: "рднрд╛рд╖рд╛:",
            connecting: "рдХрдиреЗрдХреНрдЯ рд╣реЛ рд░рд╣рд╛ рд╣реИ...",
            registerButton: "рдЬреБрдбрд╝реЗрдВ (Join)",
            votePrompt: "рдЪреЛрд░ рдХреМрди рд╣реИ? рд╡реЛрдЯ рдХрд░реЗрдВ:",
            submitVote: "рд╡реЛрдЯ рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ",
            chatTitle: "рдЦрд┐рд▓рд╛рдбрд╝рд┐рдпреЛрдВ рд╕реЗ рдмрд╛рддрдЪреАрдд (рдорд╛рдЗрдХреНрд░реЛрдлрд╝реЛрди рдЪреИрдЯ рдХреЗ рдмрдЬрд╛рдп)",
            sendButton: "рднреЗрдЬреЗрдВ",
            totalScoreTitle: "ЁЯПЖ рдХреБрд▓ рд╕реНрдХреЛрд░",
            activePlayersTitle: "рд╕рдХреНрд░рд┐рдп рдЦрд┐рд▓рд╛рдбрд╝реА",
            chatPlaceholder: "рд╕рдВрджреЗрд╢ рд▓рд┐рдЦреЗрдВ...",
            roundInfo: (round, max) => `рд░рд╛рдЙрдВрдб: ${round}/${max}`,
            waiting: (count) => `рдЦрд┐рд▓рд╛рдбрд╝рд┐рдпреЛрдВ рдХрд╛ рдЗрдВрддрдЬрд╝рд╛рд░ рд╣реИ... (${count}/рек)`,
            startStatus: (round) => `рдирдпрд╛ рд░рд╛рдЙрдВрдб ${round} рд╢реБрд░реВ! рдЪреЛрд░ рдХреЛ рдЦреЛрдЬреЗрдВред`,
            voteSubmitted: "рдЖрдкрдХрд╛ рд╡реЛрдЯ рд╕рдмрдорд┐рдЯ рд╣реЛ рдЧрдпрд╛ рд╣реИред рдЕрдиреНрдп рдЦрд┐рд▓рд╛рдбрд╝рд┐рдпреЛрдВ рдХрд╛ рдЗрдВрддрдЬрд╝рд╛рд░ рдХрд░реЗрдВ...",
            alertVote: "рдХреГрдкрдпрд╛ рдЪреЛрд░ рдХреЛ рд╡реЛрдЯ рдХрд░реЗрдВред",
            roundResultTitle: (round) => `рд░рд╛рдЙрдВрдб ${round} рдкрд░рд┐рдгрд╛рдо`,
            thiefResult: (name, caught) => `рд╕рд╣реА рдЪреЛрд░: ${name} (${caught ? 'рдкрдХрдбрд╝рд╛ рдЧрдпрд╛!' : 'рдирд╣реАрдВ рдкрдХрдбрд╝рд╛ рдЧрдпрд╛!'})`,
            scoreDetailsTitle: "рд╡реНрдпрдХреНрддрд┐рдЧрдд рд╕реНрдХреЛрд░ рд╡рд┐рд╡рд░рдг:",
            nextRoundWait: (round) => `рдирдпрд╛ рд░рд╛рдЙрдВрдб ${round} 10 рд╕реЗрдХрдВрдб рдореЗрдВ рд╢реБрд░реВ рд╣реЛрдЧрд╛ред`,
            gameEndTitle: "ЁЯОЙ рдЧреЗрдо рд╕рдорд╛рдкреНрдд!",
            gameEndWinner: (name) => `рд╡рд┐рдЬреЗрддрд╛: ${name}`,
            gameEndMessage: (msg) => `рдЧреЗрдо рд╕рдорд╛рдкреНрддред ${msg}`,
            hostMessage: "рдЖрдк Host рд╣реИрдВред рдЖрдк рднрд╛рд╖рд╛ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВред",
            playerMessage: "рдЖрдк рдЦрд┐рд▓рд╛рдбрд╝реА рд╣реИрдВред",
            languageChangeAlert: "Host рдиреЗ рднрд╛рд╖рд╛ рдмрджрд▓ рджреА рд╣реИред",
            totalPoints: (score) => `рдХреБрд▓ рдкреЙрдЗрдВрдЯ: ${score}`,
        },
        en: {
            title: "Raja-Rani-Vazir-Chor",
            appTitle: "ЁЯСС Raja-Rani-Vazir-Chor ЁЯГП",
            languageLabel: "Language:",
            connecting: "Connecting...",
            registerButton: "Join",
            votePrompt: "Who is the thief? Vote:",
            submitVote: "Submit Vote",
            chatTitle: "Chat with Players (Instead of Voice Chat)",
            sendButton: "Send",
            totalScoreTitle: "ЁЯПЖ Total Score",
            activePlayersTitle: "Active Players",
            chatPlaceholder: "Type your message...",
            roundInfo: (round, max) => `Round: ${round}/${max}`,
            waiting: (count) => `Waiting for players... (${count}/4)`,
            startStatus: (round) => `New Round ${round} started! Find the thief.`,
            voteSubmitted: "Your vote has been submitted. Waiting for other players...",
            alertVote: "Please vote for the thief.",
            roundResultTitle: (round) => `Round ${round} Results`,
            thiefResult: (name, caught) => `The real thief was: ${name} (${caught ? 'CAUGHT!' : 'NOT CAUGHT!'})`,
            scoreDetailsTitle: "Individual Score Details:",
            nextRoundWait: (round) => `New Round ${round} will start in 10 seconds.`,
            gameEndTitle: "ЁЯОЙ Game Over!",
            gameEndWinner: (name) => `Winner: ${name}`,
            gameEndMessage: (msg) => `Game Ended. ${msg}`,
            hostMessage: "You are the Host. You can change the language.",
            playerMessage: "You are a player.",
            languageChangeAlert: "The Host has changed the language.",
            totalPoints: (score) => `Total Points: ${score}`,
        }
    };

    const roleColors = {
        'рк░рк╛ркЬрк╛': 'role-king', 'рк░рк╛ркгрлА': 'role-queen', 'рк╡ркЬрлАрк░': 'role-minister', 'ркЪрлЛрк░': 'role-thief',
        'рд░рд╛рдЬрд╛': 'role-king', 'рд░рд╛рдиреА': 'role-queen', 'рд╡рдЬреАрд░': 'role-minister', 'рдЪреЛрд░': 'role-thief',
        'King': 'role-king', 'Queen': 'role-queen', 'Minister': 'role-minister', 'Thief': 'role-thief'
    };
    
    // UI Elements (already defined)
    const nameRegistration = document.getElementById('nameRegistration');
    const mainGame = document.getElementById('mainGame');
    const registerButton = document.getElementById('registerButton');
    const gameStatus = document.getElementById('gameStatus');
    const roleDisplay = document.getElementById('roleDisplay');
    const voteForm = document.getElementById('voteForm');
    const submitVoteButton = document.getElementById('submitVoteButton');
    const roundInfo = document.getElementById('roundInfo');
    const scoreList = document.getElementById('scoreList');
    const playerNamesList = document.getElementById('playerNamesList');
    const chatBox = document.getElementById('chatBox');
    const chatMessageInput = document.getElementById('chatMessageInput');
    const sendChatButton = document.getElementById('sendChatButton');
    const resultDisplay = document.getElementById('resultDisplay');
    const langSelectorDiv = document.querySelector('.lang-selector');
    const languageSelect = document.getElementById('language-select');

    // --- ркнрк╛рк╖рк╛ ркмркжрк▓рк╡рк╛ркирлБркВ ркорлБркЦрлНркп рклркВркХрлНрк╢рки (UI ркЕрккркбрлЗркЯ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ) ---
    function updateLanguage(lang) {
        currentLang = lang;
        const currentTranslation = translations[lang];

        document.querySelectorAll('[data-translate]').forEach(element => {
            const key = element.getAttribute('data-translate');
            if (typeof currentTranslation[key] === 'string') {
                element.textContent = currentTranslation[key];
            }
        });
        
        document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
            const key = element.getAttribute('data-translate-placeholder');
            if (currentTranslation[key]) {
                element.placeholder = currentTranslation[key];
            }
        });

        // Templates ркорк╛ркЯрлЗ (ркЬрлЗрко ркХрлЗ Round Info)
        const roundTextTemplate = document.querySelector('[data-translate-template="roundInfo"]');
        if (roundTextTemplate && currentTranslation.roundInfo) {
            roundTextTemplate.textContent = currentTranslation.roundInfo(0, 10);
        }

        document.title = currentTranslation.title;
        // рк╕рлНркЯрлЗркЯрк╕ ркЕрккркбрлЗркЯ
        gameStatus.textContent = currentTranslation.connecting;
    }

    // Host ркжрлНрк╡рк╛рк░рк╛ ркнрк╛рк╖рк╛ ркмркжрк▓рк╡рк╛ркирлБркВ рк╕ркВркЪрк╛рк▓рки
    function handleLanguageChange(lang) {
        if (isHost) {
            socket.emit('setLanguage', lang); // рк╕рк░рлНрк╡рк░ркирлЗ ркЬрк╛ркг ркХрк░рлЛ
        }
    }

    // --- ркХркирлЗркХрлНрк╢рки ркЕркирлЗ рк░ркЬрлАрк╕рлНркЯрлНрк░рлЗрк╢рки ---
    socket.on('connect', () => {
        updateLanguage(currentLang); // ркХркирлЗркХрлНркЯ ркеркдрк╛ркирлА рк╕рк╛ркерлЗ ркЬ ркнрк╛рк╖рк╛ рк╕рлЗркЯ ркХрк░рлЛ
        nameRegistration.style.display = 'block';
    });
    
    socket.on('yourId', (id) => {
        myId = id;
    });
    
    // --- Host рк╕рлНркерк┐ркдрк┐ рк╕рк░рлНрк╡рк░ ркжрлНрк╡рк╛рк░рк╛ ркиркХрлНркХрлА ркерк╛ркп ркЫрлЗ ---
    socket.on('setHost', (hostStatus) => {
        isHost = hostStatus;
        const currentTranslation = translations[currentLang];
        
        if (isHost) {
            langSelectorDiv.style.display = 'block'; // Host ркорк╛ркЯрлЗ ркмркдрк╛рк╡рлЛ
            gameStatus.style.color = 'blue';
            gameStatus.textContent = currentTranslation.hostMessage;
        } else {
            langSelectorDiv.style.display = 'none'; // ркЕркирлНркп ркЦрлЗрк▓рк╛ркбрлАркУ ркорк╛ркЯрлЗ ркЫрлБрккрк╛рк╡рлЛ
            gameStatus.style.color = 'black';
            // gameStatus.textContent = currentTranslation.playerMessage; // Waiting message will overwrite this
        }
    });

    registerButton.addEventListener('click', () => {
        const playerName = document.getElementById('playerNameInput').value.trim();
        if (playerName) {
            socket.emit('registerName', playerName);
            nameRegistration.style.display = 'none';
            gameStatus.textContent = translations[currentLang].waiting(Object.keys(players).length + 1);
        }
    });
    
    // --- Host ркжрлНрк╡рк╛рк░рк╛ ркнрк╛рк╖рк╛ ркмркжрк▓рк╡рк╛ркирлБркВ рк╕ркВркЪрк╛рк▓рки ---
    socket.on('languageChanged', (newLang) => {
        currentLang = newLang;
        // Host ркжрлНрк╡рк╛рк░рк╛ ркмркжрк▓рк╛ркпрлЗрк▓рлА ркнрк╛рк╖рк╛ркирлЗ ркХрлНрк▓рк╛ркпркирлНркЯ UI ркорк╛ркВ ркЕрккркбрлЗркЯ ркХрк░рлЛ
        languageSelect.value = newLang;
        updateLanguage(newLang);
        
        // ркЬрлЛ рк╣рлБркВ Host рки рк╣рлЛркЙркВ, ркдрлЛ ркоркирлЗ ркорлЗрк╕рлЗркЬ ркЖрккрлЛ
        if (!isHost) {
            gameStatus.style.color = 'orange';
            gameStatus.textContent = translations[currentLang].languageChangeAlert;
        }
    });

    // --- рккрлНрк▓рлЗркпрк░ рк▓рк┐рк╕рлНркЯ ркЕрккркбрлЗркЯ ---
    socket.on('playerListUpdate', (playersData) => {
        players = playersData.reduce((acc, player) => {
            acc[player.id] = player;
            return acc;
        }, {});
        
        const count = Object.keys(players).length;
        const currentTranslation = translations[currentLang];

        // рк╕ркХрлНрк░рк┐ркп ркЦрлЗрк▓рк╛ркбрлАркУркирлА ркпрк╛ркжрлА ркЕрккркбрлЗркЯ ркХрк░рлЛ
        playerNamesList.innerHTML = Object.values(players).map(p => `<li>${p.name} (${currentTranslation.totalPoints(p.totalScore)})</li>`).join('');
        
        // рк╕рлНркХрлЛрк░ркмрлЛрк░рлНркб ркЕрккркбрлЗркЯ ркХрк░рлЛ
        updateScoreboard(playersData);
        
        if (count < 4) {
             gameStatus.textContent = currentTranslation.waiting(count);
             mainGame.style.display = 'none';
        }
        
        // ркЬрлЛ 4 ркЦрлЗрк▓рк╛ркбрлАркУ ркЬрлЛркбрк╛ркИ ркЧркпрк╛ рк╣рлЛркп, ркдрлЛ рк╡рлЛркЯрк┐ркВркЧ рклрлЛрк░рлНрко ркдрлИркпрк╛рк░ ркХрк░рлЛ
        if (count === 4) {
             prepareVoteForm();
             // ркЬрлЛ рк░рк╛ркЙркирлНркб рк╢рк░рлВ рки ркеркпрлЛ рк╣рлЛркп, ркдрлЛ Host ркирлЗ ркнрк╛рк╖рк╛ рк╕рлЗркЯ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ ркХрк╣рлЛ
             if(!mainGame.style.display || mainGame.style.display === 'none'){
                gameStatus.textContent = isHost ? currentTranslation.hostMessage : currentTranslation.playerMessage;
             }
        }
    });
    
    function updateScoreboard(playersData) {
        const sortedPlayers = playersData.sort((a, b) => b.totalScore - a.totalScore);
        scoreList.innerHTML = sortedPlayers.map(p => 
            `<li>${p.name}: <b>${p.totalScore}</b> ${translations[currentLang].totalPoints('').replace(':', '')}</li>`
        ).join('');
    }

    // --- ркнрлВркорк┐ркХрк╛ ркЕркирлЗ рк░рк╛ркЙркирлНркб рк╢рк░рлВ ---
    socket.on('yourRole', (role) => {
        myRole = role;
        mainGame.style.display = 'block';
        
        // ркнрлВркорк┐ркХрк╛ ркбрк┐рк╕рлНрккрлНрк▓рлЗ
        roleDisplay.textContent = `${translations[currentLang].roleDisplayLabel || 'ркдркорк╛рк░рлА ркнрлВркорк┐ркХрк╛'}: ${role}`;
        roleDisplay.className = roleColors[role] || '';
        
        // рк╡рлЛркЯрк┐ркВркЧ рк╕рлЗркХрлНрк╢рки рк░рлАрк╕рлЗркЯ ркХрк░рлЛ
        submitVoteButton.disabled = false;
        document.getElementById('voteSection').style.display = 'block';
        resultDisplay.style.display = 'none';
    });

    socket.on('newRound', (data) => {
        currentLang = data.currentLanguage;
        updateLanguage(currentLang);
        roundInfo.textContent = translations[currentLang].roundInfo(data.round, data.maxRounds);
        gameStatus.textContent = translations[currentLang].startStatus(data.round);
        resultDisplay.style.display = 'none';
        prepareVoteForm(); // ркирк╡рк╛ ркЦрлЗрк▓рк╛ркбрлАркУ ркорк╛ркЯрлЗ рклрлЛрк░рлНрко рк░рлАрк▓рлЛркб ркХрк░рлЛ
    });
    
    // --- рк╡рлЛркЯрк┐ркВркЧ рк▓рлЛркЬрк┐ркХ ---
    function prepareVoteForm() {
        voteForm.innerHTML = '';
        Object.values(players).forEach(player => {
            // рк╡рлЛркЯ ркХрк░рк╡рк╛ ркорк╛ркЯрлЗркирлА рк░рлЗркбрк┐ркпрлЛ ркмркЯрки
            const label = document.createElement('label');
            label.innerHTML = `<input type="radio" name="thiefVote" value="${player.id}" required> ${player.name}`;
            voteForm.appendChild(label);
        });
    }

    submitVoteButton.addEventListener('click', () => {
        const selectedVote = document.querySelector('input[name="thiefVote"]:checked');
        if (selectedVote) {
            socket.emit('submitVote', selectedVote.value);
            submitVoteButton.disabled = true;
            gameStatus.textContent = translations[currentLang].voteSubmitted;
        } else {
            alert(translations[currentLang].alertVote);
        }
    });

    socket.on('voteUpdate', (data) => {
        gameStatus.textContent = `${data.message}`;
    });

    // --- рккрк░рк┐ркгрк╛рко ркЕркирлЗ рк╕рлНркХрлЛрк░ ---
    socket.on('roundResult', (data) => {
        currentLang = data.currentLanguage;
        updateLanguage(currentLang);
        
        // ркнрлВркорк┐ркХрк╛ ркЕркирлЗ рк╡рлЛркЯрк┐ркВркЧ ркЫрлБрккрк╛рк╡рлЛ
        document.getElementById('voteSection').style.display = 'none';
        
        const currentTranslation = translations[currentLang];
        
        let resultMsg = `<h3>${currentTranslation.roundResultTitle(data.round)}</h3>`;
        resultMsg += `<p style="font-size: 1.2em; font-weight: bold;">${currentTranslation.thiefResult(data.thiefName, data.thiefCaught)}</p>`;
        
        // ркжрк░рлЗркХ ркЦрлЗрк▓рк╛ркбрлА ркорк╛ркЯрлЗ рк╡рлНркпркХрлНркдрк┐ркЧркд ркорлЗрк╕рлЗркЬ
        resultMsg += `<h4>${currentTranslation.scoreDetailsTitle}</h4><ul>`;
        Object.values(data.players).forEach(p => {
             // ркнрлВркорк┐ркХрк╛ркирлБркВ ркирк╛рко ркнрк╛рк╖рк╛ркВркдрк░рк┐ркд ркХрк░рлЛ
             const translatedRole = currentTranslation[p.role] || p.role;
             resultMsg += `<li>${p.name} (${translatedRole}): ${p.roundMessage}</li>`;
        });
        resultMsg += '</ul>';
        
        resultMsg += `<p>${data.nextRound}</p>`;
        
        resultDisplay.innerHTML = resultMsg;
        resultDisplay.style.display = 'block';
        
        // рк╕рлНркХрлЛрк░ркмрлЛрк░рлНркб ркЕрккркбрлЗркЯ ркХрк░рлЛ
        updateScoreboard(Object.values(data.players));
    });

    // --- ркЧрлЗрко рк╕ркорк╛рккрлНркд ---
    socket.on('gameEnd', (data) => {
        currentLang = data.currentLanguage;
        updateLanguage(currentLang);
        
        mainGame.style.display = 'none';
        const currentTranslation = translations[currentLang];
        
        if (data.winner) {
            resultDisplay.innerHTML = `<h2>${currentTranslation.gameEndTitle} ${currentTranslation.gameEndWinner(data.winner.name)}</h2>`;
            resultDisplay.innerHTML += `<p>${currentTranslation.totalPoints(data.winner.totalScore)}</p>`;
        } else {
            resultDisplay.innerHTML = `<h2>${currentTranslation.gameEndTitle}</h2><p>${currentTranslation.gameEndMessage(data.message)}</p>`;
        }
        
        // рк╕рлНркХрлЛрк░ркмрлЛрк░рлНркб рклрк░рлА ркПркХрк╡рк╛рк░ ркЕрккркбрлЗркЯ ркХрк░рлЛ
        updateScoreboard(Object.values(data.finalScores || players));
        gameStatus.textContent = currentTranslation.gameEndMessage('рклрк░рлАркерлА рк░ркорк╡рк╛ ркорк╛ркЯрлЗ ркмркзрк╛ркП рк░рлАрклрлНрк░рлЗрк╢ ркХрк░рлЛ.');
    });
    
    // --- ркЪрлЗркЯ рк▓рлЛркЬрк┐ркХ ---
    sendChatButton.addEventListener('click', () => {
        const message = chatMessageInput.value.trim();
        if (message) {
            socket.emit('chatMessage', message);
            chatMessageInput.value = '';
            chatBox.scrollTop = chatBox.scrollHeight; // рк╕рлНркХрлНрк░рлЛрк▓ ркбрк╛ркЙрки
        }
    });
    
    // Enter key рккрк░ рккркг ркЪрлЗркЯ ркорлЛркХрк▓рлЛ
    chatMessageInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault(); // рклрлЛрк░рлНрко рк╕ркмркорк┐ркЯ рки ркерк╛ркп ркдрлЗ ркорк╛ркЯрлЗ
            sendChatButton.click();
        }
    });

    socket.on('chatMessage', (data) => {
        const p = document.createElement('p');
        p.innerHTML = `<strong>${data.name}:</strong> ${data.message}`;
        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // рк╢рк░рлВркЖркдркорк╛ркВ ркнрк╛рк╖рк╛ рк▓рлЛркб ркХрк░рлЛ
    updateLanguage('gu');
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(registration => {
        console.log('ServiceWorker registered:', registration);
      })
      .catch(error => {
        console.log('ServiceWorker registration failed:', error);
      });
  });
}
</script>

</body>
</html>
